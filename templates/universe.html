<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="app-version" content="{{ app_version }}">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AudioMuse-AI - Song Universe Map</title>
    <link rel="stylesheet" href="/static/style.css">
    <link rel="stylesheet" href="/static/menu.css">
    <style>
        /* Universe-specific styles */
        .universe-container {
            position: relative;
            width: 100%;
            height: 100vh;
            background: radial-gradient(ellipse at center, #0a0a23 0%, #000000 100%);
            overflow: hidden;
            cursor: grab;
        }

        .universe-container:active {
            cursor: grabbing;
        }

        .universe-canvas {
            position: absolute;
            width: 200%;
            height: 200%;
            transform-origin: center;
            transition: transform 0.6s cubic-bezier(0.25, 0.8, 0.25, 1);
        }

        /* Stars background */
        .stars {
            position: absolute;
            width: 100%;
            height: 100%;
            background-image: 
                radial-gradient(2px 2px at 20px 30px, #fff, transparent),
                radial-gradient(2px 2px at 40px 70px, #fff, transparent),
                radial-gradient(1px 1px at 90px 40px, #fff, transparent),
                radial-gradient(1px 1px at 130px 80px, #fff, transparent),
                radial-gradient(2px 2px at 160px 30px, #fff, transparent);
            background-repeat: repeat;
            background-size: 200px 100px;
            animation: twinkle 4s infinite;
        }

        @keyframes twinkle {
            0%, 100% { opacity: 0.8; }
            50% { opacity: 0.4; }
        }

        /* Genre regions */
        .genre-region {
            position: absolute;
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            text-align: center;
            color: white;
            font-weight: bold;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.8);
            transition: all 0.3s ease;
            border: 2px solid rgba(255,255,255,0.3);
            backdrop-filter: blur(2px);
        }

        .genre-region:hover {
            transform: scale(1.1);
            box-shadow: 0 0 30px rgba(255,255,255,0.5);
            border-color: rgba(255,255,255,0.8);
        }

        .genre-region.large {
            width: 120px;
            height: 120px;
            font-size: 14px;
        }

        .genre-region.medium {
            width: 100px;
            height: 100px;
            font-size: 12px;
        }

        .genre-region.small {
            width: 80px;
            height: 80px;
            font-size: 10px;
        }

        /* Genre-specific colors */
        .genre-rock { background: radial-gradient(circle, rgba(220,20,60,0.7), rgba(139,0,0,0.4)); }
        .genre-pop { background: radial-gradient(circle, rgba(255,20,147,0.7), rgba(199,21,133,0.4)); }
        .genre-electronic { background: radial-gradient(circle, rgba(0,191,255,0.7), rgba(30,144,255,0.4)); }
        .genre-jazz { background: radial-gradient(circle, rgba(255,215,0,0.7), rgba(218,165,32,0.4)); }
        .genre-metal { background: radial-gradient(circle, rgba(105,105,105,0.7), rgba(47,79,79,0.4)); }
        .genre-folk { background: radial-gradient(circle, rgba(34,139,34,0.7), rgba(85,107,47,0.4)); }
        .genre-indie { background: radial-gradient(circle, rgba(138,43,226,0.7), rgba(75,0,130,0.4)); }
        .genre-blues { background: radial-gradient(circle, rgba(0,0,255,0.7), rgba(25,25,112,0.4)); }
        .genre-alternative { background: radial-gradient(circle, rgba(255,69,0,0.7), rgba(255,140,0,0.4)); }
        .genre-default { background: radial-gradient(circle, rgba(128,128,128,0.7), rgba(64,64,64,0.4)); }

        /* Search overlay */
        .search-overlay {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 1000;
            background: rgba(0,0,0,0.8);
            padding: 15px;
            border-radius: 10px;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255,255,255,0.2);
        }

        .search-input {
            background: rgba(255,255,255,0.1);
            border: 1px solid rgba(255,255,255,0.3);
            color: white;
            padding: 8px 12px;
            border-radius: 5px;
            margin-right: 10px;
            width: 250px;
        }

        .search-input::placeholder {
            color: rgba(255,255,255,0.6);
        }

        /* Controls */
        .controls {
            position: fixed;
            bottom: 20px;
            right: 20px;
            z-index: 1000;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .control-btn {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: rgba(0,0,0,0.8);
            border: 2px solid rgba(255,255,255,0.3);
            color: white;
            font-size: 20px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
        }

        .control-btn:hover {
            background: rgba(255,255,255,0.1);
            border-color: rgba(255,255,255,0.8);
            transform: scale(1.1);
        }

        /* Song markers */
        .song-marker {
            position: absolute;
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: rgba(255,255,255,0.9);
            cursor: pointer;
            transition: all 0.3s ease;
            opacity: 0;
            animation: fadeIn 0.5s ease forwards;
            border: 1px solid rgba(255,255,255,0.6);
        }

        .song-marker:hover {
            width: 16px;
            height: 16px;
            margin: -4px 0 0 -4px;
            background: rgba(255,255,0,1);
            box-shadow: 0 0 20px rgba(255,255,0,0.8);
            border: 2px solid rgba(255,255,255,1);
        }

        .song-marker.center-song {
            width: 12px;
            height: 12px;
            background: rgba(255,255,0,1);
            box-shadow: 0 0 20px rgba(255,255,0,0.8);
            border: 2px solid rgba(255,255,255,1);
            z-index: 100;
        }

        .song-marker.neighbor {
            background: rgba(0,255,255,0.8);
        }

        /* Song info tooltip */
        .song-info {
            position: absolute;
            background: rgba(0,0,0,0.9);
            color: white;
            padding: 8px 12px;
            border-radius: 6px;
            font-size: 12px;
            pointer-events: none;
            z-index: 1001;
            white-space: nowrap;
            border: 1px solid rgba(255,255,255,0.3);
            box-shadow: 0 4px 12px rgba(0,0,0,0.5);
            transform: translate(-50%, -100%);
            margin-top: -10px;
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .song-info.visible {
            opacity: 1;
        }

        .song-info.center-info {
            opacity: 1 !important;
            background: rgba(0,0,0,1);
            border-color: rgba(255,255,0,0.8);
            font-weight: bold;
        }

        .song-info .title {
            font-weight: bold;
            color: #ffeb3b;
        }

        .song-info .artist {
            color: #e0e0e0;
            font-size: 11px;
        }

        @keyframes fadeIn {
            to { opacity: 1; }
        }

        /* Info panel */
        .info-panel {
            position: fixed;
            bottom: 20px;
            left: 20px;
            z-index: 1000;
            background: rgba(0,0,0,0.9);
            padding: 15px;
            border-radius: 10px;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255,255,255,0.3);
            color: white;
            max-width: 300px;
            display: none;
            box-shadow: 0 4px 20px rgba(0,0,0,0.6);
        }

        .info-panel h3 {
            color: #ffeb3b;
            margin: 0 0 8px 0;
            font-size: 16px;
        }

        .info-panel p {
            color: #e0e0e0;
            margin: 0;
            line-height: 1.4;
        }

        .zoom-level {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 1000;
            background: rgba(0,0,0,0.8);
            color: white;
            padding: 10px 15px;
            border-radius: 5px;
            font-family: monospace;
        }

        /* Autocomplete styles */
        .autocomplete-item {
            padding: 10px;
            cursor: pointer;
            border-bottom: 1px solid rgba(255,255,255,0.1);
            color: white;
        }

        .autocomplete-item:hover {
            background: rgba(255,255,255,0.1);
        }

        .autocomplete-item .title {
            font-weight: bold;
            color: #ffeb3b;
        }

        .autocomplete-item .artist {
            font-size: 0.9em;
            color: #e0e0e0;
        }

        .hidden {
            display: none;
        }
    </style>
</head>
<body>

<div class="page-container">
    <aside class="sidebar">
        <nav>
            <ul class="sidebar-nav">
                <!-- Menu items are dynamically inserted by menu.js -->
            </ul>
        </nav>
    </aside>

    <div class="main-content" id="main-content">
        <button class="menu-toggle">&#9776;</button>
        
        <!-- Search overlay -->
        <div class="search-overlay">
            <div style="display: flex; gap: 10px; align-items: center;">
                <div class="autocomplete-container" style="position: relative;">
                    <input type="text" class="search-input" id="artist_search" placeholder="Artist name..." autocomplete="off" style="width: 150px;">
                </div>
                <div class="autocomplete-container" style="position: relative;">
                    <input type="text" class="search-input" id="title_search" placeholder="Track title..." autocomplete="off" style="width: 150px;">
                    <div id="autocomplete-results" class="autocomplete-results hidden" style="position: absolute; top: 100%; left: 0; right: 0; background: rgba(0,0,0,0.95); border: 1px solid rgba(255,255,255,0.3); border-radius: 5px; max-height: 200px; overflow-y: auto; z-index: 2000;"></div>
                </div>
                <button class="control-btn" style="width: auto; height: auto; padding: 8px 15px; border-radius: 5px;" onclick="searchSimilar()">Search</button>
            </div>
            <input type="hidden" id="selected_item_id">
        </div>

        <!-- Zoom level indicator -->
        <div class="zoom-level" id="zoom-level">Universe View</div>

        <!-- Universe container -->
        <div class="universe-container" id="universe-container">
            <div class="stars"></div>
            <div class="universe-canvas" id="universe-canvas">
                <!-- Genres will be positioned here -->
            </div>
        </div>

        <!-- Controls -->
        <div class="controls">
            <div class="control-btn" onclick="zoomIn()" title="Zoom In">+</div>
            <div class="control-btn" onclick="zoomOut()" title="Zoom Out">−</div>
            <div class="control-btn" onclick="resetView()" title="Reset View">⌂</div>
        </div>

        <!-- Info panel -->
        <div class="info-panel" id="info-panel">
            <h3 id="info-title"></h3>
            <p id="info-content"></p>
        </div>
    </div>
</div>

<script>
(() => {
    // Configuration
    const STRATIFIED_GENRES = [
        'rock', 'pop', 'alternative', 'indie', 'electronic', 'jazz', 'metal', 'classic rock', 'soul',
        'indie rock', 'electronica', 'folk', 'punk', 'blues', 'hard rock', 'ambient', 'acoustic',
        'experimental', 'Hip-Hop', 'country', 'funk', 'electro', 'heavy metal', 'Progressive rock',
        'rnb', 'indie pop', 'House'
    ];

    // State
    let currentZoom = 1;
    let currentPosition = { x: 0, y: 0 };
    let isDragging = false;
    let dragStart = { x: 0, y: 0 };
    let selectedGenre = null;
    let searchTimeout;
    let isInSongView = false;

    // DOM elements
    const container = document.getElementById('universe-container');
    const canvas = document.getElementById('universe-canvas');
    const searchInput = document.getElementById('search-input');
    const zoomLevel = document.getElementById('zoom-level');
    const infoPanel = document.getElementById('info-panel');

    // Initialize the universe
    function initUniverse() {
        createGenreRegions();
        setupEventListeners();
    }

    function createGenreRegions() {
        const centerX = window.innerWidth;
        const centerY = window.innerHeight;
        const radius = Math.min(centerX, centerY) * 0.3;

        STRATIFIED_GENRES.forEach((genre, index) => {
            const angle = (index / STRATIFIED_GENRES.length) * 2 * Math.PI;
            const distance = radius + (Math.random() * radius * 0.5);
            
            const x = centerX + Math.cos(angle) * distance;
            const y = centerY + Math.sin(angle) * distance;

            const region = document.createElement('div');
            region.className = `genre-region large genre-${getGenreClass(genre)}`;
            region.style.left = `${x}px`;
            region.style.top = `${y}px`;
            region.textContent = genre;
            region.dataset.genre = genre;
            
            region.addEventListener('click', () => exploreGenre(genre, region));
            canvas.appendChild(region);
        });
    }

    function getGenreClass(genre) {
        const colorMap = {
            'rock': 'rock', 'pop': 'pop', 'electronic': 'electronic', 'electronica': 'electronic',
            'jazz': 'jazz', 'metal': 'metal', 'heavy metal': 'metal',
            'folk': 'folk', 'indie': 'indie', 'indie rock': 'indie', 'indie pop': 'indie',
            'blues': 'blues', 'alternative': 'alternative', 'alternative rock': 'alternative'
        };
        return colorMap[genre.toLowerCase()] || 'default';
    }

    function exploreGenre(genre, element) {
        selectedGenre = genre;
        isInSongView = true;
        showInfo(`Exploring ${genre}`, 'Loading songs in this genre...');
        
        // Get the current position of the genre element in canvas space
        const genreX = parseInt(element.style.left);
        const genreY = parseInt(element.style.top);
        
        // Calculate where we want the genre to be (center of screen)
        const targetScreenX = container.offsetWidth / 2;
        const targetScreenY = container.offsetHeight / 2;
        
        // Set new zoom level for song exploration - only 1.6x allowed
        const newZoom = 1.6;
        
        // Calculate new position to center the genre
        currentPosition.x = targetScreenX - (genreX * newZoom);
        currentPosition.y = targetScreenY - (genreY * newZoom);
        currentZoom = newZoom;
        
        // Hide all genre regions in song view
        document.querySelectorAll('.genre-region').forEach(region => {
            region.style.display = 'none';
        });
        
        updateCanvasTransform();
        updateZoomLevel();
        
        // Load real songs from the API
        loadGenreSongs(genre, element);
    }

    async function loadGenreSongs(genre, genreElement) {
        try {
            const response = await fetch(`/api/universe/genre_songs?genre=${encodeURIComponent(genre)}&limit=15`);
            if (!response.ok) {
                throw new Error(`HTTP ${response.status}: ${response.statusText}`);
            }
            
            const songs = await response.json();
            
            if (songs.length === 0) {
                showInfo(`${genre} Region`, 'No songs found for this genre.');
                return;
            }
            
            generateRealSongMarkers(songs, genreElement);
            
        } catch (error) {
            console.error('Error loading genre songs:', error);
            showInfo(`${genre} Region`, 'Error loading songs for this genre.');
        }
    }

    function generateRealSongMarkers(songs, genreElement) {
        // Remove existing song markers and info tooltips
        document.querySelectorAll('.song-marker').forEach(marker => marker.remove());
        document.querySelectorAll('.song-info').forEach(info => info.remove());
        
        if (songs.length === 0) return;
        
        // Select a random song as the center
        const centerSongIndex = Math.floor(Math.random() * songs.length);
        const centerSong = songs[centerSongIndex];
        
        // Get genre element position in canvas coordinates
        const genreX = parseInt(genreElement.style.left);
        const genreY = parseInt(genreElement.style.top);
        
        // Create center song marker with title always visible
        const centerMarker = document.createElement('div');
        centerMarker.className = 'song-marker center-song';
        centerMarker.style.left = `${genreX}px`;
        centerMarker.style.top = `${genreY}px`;
        centerMarker.dataset.itemId = centerSong.item_id;
        centerMarker.dataset.title = centerSong.title;
        centerMarker.dataset.author = centerSong.author;
        
        // Create always-visible info for center song
        const centerInfo = document.createElement('div');
        centerInfo.className = 'song-info center-info';
        centerInfo.style.left = `${genreX}px`;
        centerInfo.style.top = `${genreY}px`;
        centerInfo.innerHTML = `<div class="title">${centerSong.title}</div><div class="artist">${centerSong.author}</div>`;
        
        centerMarker.addEventListener('click', () => {
            makeNewCenter(centerSong, genreX, genreY);
        });
        
        canvas.appendChild(centerMarker);
        canvas.appendChild(centerInfo);
        
        showInfo(`♪ ${centerSong.title}`, `by ${centerSong.author}<br><br>Loading similar songs...`);
        
        // Find similar songs for this center
        findSimilarSongs(centerSong, genreX, genreY);
    }

    async function findSimilarSongs(centerSong, centerX, centerY) {
        try {
            const response = await fetch(`/api/similar_tracks?item_id=${encodeURIComponent(centerSong.item_id)}&n=8&eliminate_duplicates=true`);
            
            if (!response.ok) {
                console.error(`Similarity API error: ${response.status}`);
                return;
            }
            
            const similarSongs = await response.json();
            
            if (similarSongs.length === 0) {
                showInfo(`♪ ${centerSong.title}`, `by ${centerSong.author}<br><br>No similar songs found.`);
                return;
            }
            
            // Get list of songs already on the map to prevent duplicates
            const existingSongIds = new Set();
            document.querySelectorAll('.song-marker').forEach(marker => {
                if (marker.dataset.itemId) {
                    existingSongIds.add(marker.dataset.itemId);
                }
            });
            
            // Filter out songs that are already on the map
            const newSimilarSongs = similarSongs.filter(song => !existingSongIds.has(song.item_id));
            
            if (newSimilarSongs.length === 0) {
                showInfo(`♪ ${centerSong.title}`, `by ${centerSong.author}<br><br>All similar songs are already on the map!`);
                return;
            }
            
            // Place similar songs in a circle around the center
            newSimilarSongs.forEach((song, index) => {
                const angle = (index / newSimilarSongs.length) * 2 * Math.PI;
                const distance = 80 + (Math.random() * 40); // 80-120px from center
                
                const x = centerX + Math.cos(angle) * distance;
                const y = centerY + Math.sin(angle) * distance;
                
                const marker = document.createElement('div');
                marker.className = 'song-marker neighbor';
                marker.style.left = `${x}px`;
                marker.style.top = `${y}px`;
                marker.dataset.itemId = song.item_id;
                marker.dataset.title = song.title;
                marker.dataset.author = song.author;
                
                // Create info tooltip for neighbor songs (show on hover)
                const info = document.createElement('div');
                info.className = 'song-info';
                info.style.left = `${x}px`;
                info.style.top = `${y}px`;
                info.innerHTML = `<div class="title">${song.title}</div><div class="artist">${song.author}</div>`;
                
                // Show info on hover
                marker.addEventListener('mouseenter', () => {
                    info.classList.add('visible');
                });
                marker.addEventListener('mouseleave', () => {
                    info.classList.remove('visible');
                });
                
                marker.addEventListener('click', () => {
                    makeNewCenter(song, x, y);
                });
                
                canvas.appendChild(marker);
                canvas.appendChild(info);
            });
            
            showInfo(`♪ ${centerSong.title}`, `by ${centerSong.author}<br><br>Found ${newSimilarSongs.length} new similar songs nearby!`);
            
        } catch (error) {
            console.error('Error finding similar songs:', error);
            showInfo(`♪ ${centerSong.title}`, `by ${centerSong.author}<br><br>Error finding similar songs.`);
        }
    }

    function makeNewCenter(song, x, y) {
        // Only remove neighbor songs (not center songs or selected songs)
        document.querySelectorAll('.song-marker.neighbor').forEach(marker => marker.remove());
        document.querySelectorAll('.song-info:not(.center-info):not(.selected-info)').forEach(info => info.remove());
        
        // Mark the clicked song as selected and create new center
        const centerMarker = document.createElement('div');
        centerMarker.className = 'song-marker center-song selected';
        centerMarker.style.left = `${x}px`;
        centerMarker.style.top = `${y}px`;
        centerMarker.dataset.itemId = song.item_id;
        centerMarker.dataset.title = song.title;
        centerMarker.dataset.author = song.author;
        
        // Create always-visible info for new center song
        const centerInfo = document.createElement('div');
        centerInfo.className = 'song-info center-info selected-info';
        centerInfo.style.left = `${x}px`;
        centerInfo.style.top = `${y}px`;
        centerInfo.innerHTML = `<div class="title">${song.title}</div><div class="artist">${song.author}</div>`;
        
        centerMarker.addEventListener('click', () => {
            makeNewCenter(song, x, y);
        });
        
        canvas.appendChild(centerMarker);
        canvas.appendChild(centerInfo);
        
        showInfo(`♪ ${song.title}`, `by ${song.author}<br><br>Loading similar songs...`);
        
        // Find similar songs for the new center
        findSimilarSongs(song, x, y);
    }

    function setupEventListeners() {
        // Dragging
        container.addEventListener('mousedown', startDrag);
        container.addEventListener('mousemove', drag);
        container.addEventListener('mouseup', endDrag);
        container.addEventListener('mouseleave', endDrag);
        
        // Touch events for mobile
        container.addEventListener('touchstart', (e) => startDrag(e.touches[0]));
        container.addEventListener('touchmove', (e) => {
            e.preventDefault();
            drag(e.touches[0]);
        });
        container.addEventListener('touchend', endDrag);
        
        // Allow wheel zoom out from song view to universe view
        container.addEventListener('wheel', (e) => {
            e.preventDefault();
            if (e.deltaY > 0 && isInSongView) {
                // Zoom out from song view to universe view
                zoomOut();
            }
        });

        // Search input
        setupSearchAutocomplete();

        // Window resize
        window.addEventListener('resize', () => {
            // Recalculate positions if needed
        });
    }

    function startDrag(e) {
        isDragging = true;
        dragStart.x = e.clientX - currentPosition.x;
        dragStart.y = e.clientY - currentPosition.y;
        container.style.cursor = 'grabbing';
    }

    function drag(e) {
        if (!isDragging) return;
        
        currentPosition.x = e.clientX - dragStart.x;
        currentPosition.y = e.clientY - dragStart.y;
        
        updateCanvasTransform();
    }

    function endDrag() {
        isDragging = false;
        container.style.cursor = 'grab';
    }

    function zoomIn() {
        // Only allow zoom in if we're at 1x zoom (universe view)
        if (currentZoom === 1 && !isInSongView) {
            // Do nothing - user must click on a genre to explore
            showInfo('Universe View', 'Click on a genre region to explore its songs!');
        }
    }

    function zoomOut() {
        console.log('Zoom out clicked. Current zoom:', currentZoom, 'isInSongView:', isInSongView);
        // Only allow zoom out from song view back to universe view
        if (isInSongView || currentZoom > 1) {
            console.log('Resetting to universe view');
            resetView();
        } else {
            console.log('Already at universe level');
        }
    }

    function resetView() {
        currentZoom = 1;
        currentPosition = { x: 0, y: 0 };
        selectedGenre = null;
        isInSongView = false;
        
        // Show all genre regions in universe view
        document.querySelectorAll('.genre-region').forEach(region => {
            region.style.display = 'flex';
        });
        
        // Remove song markers and info tooltips
        document.querySelectorAll('.song-marker').forEach(marker => marker.remove());
        document.querySelectorAll('.song-info').forEach(info => info.remove());
        
        updateCanvasTransform();
        updateZoomLevel();
        hideInfo();
    }

    function updateCanvasTransform() {
        canvas.style.transform = `translate(${currentPosition.x}px, ${currentPosition.y}px) scale(${currentZoom})`;
    }

    function updateZoomLevel() {
        let level = 'Universe View (Genres)';
        if (currentZoom === 1.6 && isInSongView) level = 'Song Explorer';
        
        zoomLevel.textContent = `${level} (${currentZoom.toFixed(1)}x)`;
    }

    // Search and autocomplete functionality
    function setupSearchAutocomplete() {
        const artistInput = document.getElementById('artist_search');
        const titleInput = document.getElementById('title_search');
        const selectedItemIdInput = document.getElementById('selected_item_id');
        const autocompleteResults = document.getElementById('autocomplete-results');
        let searchTimeout;

        const handleSearchInput = () => {
            clearTimeout(searchTimeout);
            searchTimeout = setTimeout(async () => {
                const artistQuery = artistInput.value.trim();
                const titleQuery = titleInput.value.trim();

                if (artistQuery.length < 3 && titleQuery.length < 3) {
                    hideAutocomplete();
                    return;
                }

                try {
                    const params = new URLSearchParams({ artist: artistQuery, title: titleQuery });
                    const response = await fetch(`/api/search_tracks?${params}`);
                    const tracks = await response.json();
                    showAutocomplete(tracks);
                } catch (error) {
                    console.error('Autocomplete search error:', error);
                    hideAutocomplete();
                }
            }, 300);
        };
        
        const showAutocomplete = (tracks) => {
            autocompleteResults.innerHTML = '';
            if (tracks.length === 0) {
                autocompleteResults.innerHTML = '<div class="autocomplete-item"><em>No results found</em></div>';
            } else {
                tracks.forEach(track => {
                    const itemDiv = document.createElement('div');
                    itemDiv.className = 'autocomplete-item';
                    itemDiv.innerHTML = `<div class="title">${track.title}</div><div class="artist">${track.author}</div>`;
                    itemDiv.addEventListener('click', () => selectTrack(track));
                    autocompleteResults.appendChild(itemDiv);
                });
            }
            autocompleteResults.classList.remove('hidden');
        };

        const hideAutocomplete = () => {
            autocompleteResults.classList.add('hidden');
        };

        const selectTrack = (track) => {
            artistInput.value = track.author;
            titleInput.value = track.title;
            selectedItemIdInput.value = track.item_id;
            hideAutocomplete();
        };

        artistInput.addEventListener('input', handleSearchInput);
        titleInput.addEventListener('input', handleSearchInput);
        
        document.addEventListener('click', (e) => {
            if (!e.target.closest('.autocomplete-container')) {
                hideAutocomplete();
            }
        });
    }

    async function searchSimilar() {
        const selectedItemId = document.getElementById('selected_item_id').value;
        const artistInput = document.getElementById('artist_search');
        const titleInput = document.getElementById('title_search');
        
        if (!selectedItemId) {
            showInfo('Search Error', 'Please select a track from the autocomplete suggestions.');
            return;
        }
        
        const song = {
            item_id: selectedItemId,
            title: titleInput.value,
            author: artistInput.value
        };
        
        showInfo('Searching...', 'Finding song in the universe...');
        
        try {
            // Switch to song view for search results
            currentZoom = 1.6;
            isInSongView = true;
            
            // Hide genres in song view
            document.querySelectorAll('.genre-region').forEach(region => {
                region.style.display = 'none';
            });
            
            // Position search result in a new area (not overlapping existing songs)
            const searchX = window.innerWidth + 200; // Place to the right of existing content
            const searchY = window.innerHeight / 2;
            
            // Center the view on the search result
            currentPosition.x = (container.offsetWidth / 2) - (searchX * currentZoom);
            currentPosition.y = (container.offsetHeight / 2) - (searchY * currentZoom);
            
            updateCanvasTransform();
            updateZoomLevel();
            
            // Create the search result as center and find its neighbors
            makeNewCenter(song, searchX, searchY);
            
        } catch (error) {
            console.error('Search error:', error);
            showInfo('Search Error', `Could not find the selected track. Try a different search.`);
        }
    }

    function showInfo(title, content) {
        document.getElementById('info-title').textContent = title;
        document.getElementById('info-content').innerHTML = content;
        infoPanel.style.display = 'block';
    }

    function hideInfo() {
        infoPanel.style.display = 'none';
    }

    // Initialize when page loads
    initUniverse();
})();
</script>

<script src="/static/menu.js"></script>
</body>
</html>