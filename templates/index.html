<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AudioMuse-AI</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #1a1a1a; /* Dark background */
        }
        /* Custom scrollbar for log area */
        .log-area::-webkit-scrollbar {
            width: 8px;
        }
        .log-area::-webkit-scrollbar-track {
            background: #2d2d2d;
            border-radius: 10px;
        }
        .log-area::-webkit-scrollbar-thumb {
            background: #3b82f6; /* Blue-500 */
            border-radius: 10px;
        }
        .log-area::-webkit-scrollbar-thumb:hover {
            background: #2563eb; /* Blue-600 on hover */
        }
        /* Style for fieldset borders */
        .fieldset-border {
            border: 1px solid #1e40af; /* Blue-800 */
            border-radius: 0.5rem; /* rounded-lg */
            padding: 1.5rem; /* p-6 */
            margin-bottom: 2rem; /* mb-8 */
        }
        .fieldset-legend {
            color: #93c5fd; /* Blue-300 */
            font-size: 1.25rem; /* text-2xl */
            font-weight: 600; /* font-semibold */
            padding: 0 0.5rem;
            margin-left: -0.5rem; /* Adjust to align with fieldset */
        }
    </style>
</head>
<body class="flex items-center justify-center min-h-screen p-4 sm:p-6 bg-gradient-to-br from-gray-900 to-black">
    <div class="bg-gray-800 p-6 sm:p-8 rounded-xl shadow-2xl w-full max-w-4xl border border-blue-700">
        <h1 class="text-4xl sm:text-5xl font-extrabold text-center text-blue-400 mb-8 tracking-wide">
            AudioMuse-AI
        </h1>

        <div id="loading-spinner" class="hidden flex justify-center items-center py-8">
            <div class="animate-spin rounded-full h-16 w-16 border-t-4 border-b-4 border-blue-500"></div>
            <p class="ml-4 text-blue-300 text-lg">Loading...</p>
        </div>

        <div id="main-content" class="hidden">
            <section class="mb-8 p-6 bg-gray-900 rounded-lg shadow-inner border border-blue-800">
                <h2 class="text-2xl font-semibold text-blue-300 mb-4 flex items-center">
                    <i class="fas fa-cog mr-3 text-blue-500"></i>Configuration Parameters
                </h2>
                <form id="config-form" class="text-gray-300">
                    <fieldset class="fieldset-border">
                        <legend class="fieldset-legend flex items-center">
                            <i class="fas fa-server mr-2"></i>General Parameters
                        </legend>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div class="mb-2">
                                <label for="config-jellyfin_url" class="block text-sm font-medium text-gray-400 mb-1">Jellyfin URL:</label>
                                <input type="text" id="config-jellyfin_url" class="w-full p-2 rounded-md bg-gray-700 border border-gray-600 focus:border-blue-500 focus:ring focus:ring-blue-500 focus:ring-opacity-50 text-gray-200">
                            </div>
                            <div class="mb-2">
                                <label for="config-jellyfin_user_id" class="block text-sm font-medium text-gray-400 mb-1">Jellyfin User ID:</label>
                                <input type="text" id="config-jellyfin_user_id" class="w-full p-2 rounded-md bg-gray-700 border border-gray-600 focus:border-blue-500 focus:ring focus:ring-blue-500 focus:ring-opacity-50 text-gray-200">
                            </div>
                            <div class="mb-2">
                                <label for="config-jellyfin_token" class="block text-sm font-medium text-gray-400 mb-1">Jellyfin Token:</label>
                                <input type="text" id="config-jellyfin_token" class="w-full p-2 rounded-md bg-gray-700 border border-gray-600 focus:border-blue-500 focus:ring focus:ring-blue-500 focus:ring-opacity-50 text-gray-200">
                            </div>
                        </div>
                    </fieldset>

                    <fieldset class="fieldset-border">
                        <legend class="fieldset-legend flex items-center">
                            <i class="fas fa-chart-bar mr-2"></i>Analysis Parameters
                        </legend>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div class="mb-2">
                                <label for="config-num_recent_albums" class="block text-sm font-medium text-gray-400 mb-1">Number of Recent Albums:</label>
                                <input type="number" id="config-num_recent_albums" class="w-full p-2 rounded-md bg-gray-700 border border-gray-600 focus:border-blue-500 focus:ring focus:ring-blue-500 focus:ring-opacity-50 text-gray-200">
                            </div>
                            <div class="mb-2">
                                <label for="config-top_n_moods" class="block text-sm font-medium text-gray-400 mb-1">Top N Moods:</label>
                                <input type="number" id="config-top_n_moods" class="w-full p-2 rounded-md bg-gray-700 border border-gray-600 focus:border-blue-500 focus:ring focus:ring-blue-500 focus:ring-opacity-50 text-gray-200">
                            </div>
                            </div>
                    </fieldset>

                    <fieldset class="fieldset-border">
                        <legend class="fieldset-legend flex items-center">
                            <i class="fas fa-sitemap mr-2"></i>Clustering Parameters
                        </legend>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div class="mb-2">
                                <label for="config-cluster_algorithm" class="block text-sm font-medium text-gray-400 mb-1">Clustering Algorithm:</label>
                                <select id="config-cluster_algorithm" class="w-full p-2 rounded-md bg-gray-700 border border-gray-600 focus:border-blue-500 focus:ring focus:ring-blue-500 focus:ring-opacity-50 text-gray-200">
                                    <option value="kmeans">K-Means</option>
                                    <option value="dbscan">DBSCAN</option>
                                    <option value="gmm">GMM</option>
                                </select>
                            </div>
                            <div class="mb-2">
                                <label for="config-max_distance" class="block text-sm font-medium text-gray-400 mb-1">Max Distance:</label>
                                <input type="number" step="0.01" id="config-max_distance" class="w-full p-2 rounded-md bg-gray-700 border border-gray-600 focus:border-blue-500 focus:ring focus:ring-blue-500 focus:ring-opacity-50 text-gray-200">
                            </div>
                            <div class="mb-2">
                                <label for="config-max_songs_per_cluster" class="block text-sm font-medium text-gray-400 mb-1">Max Songs Per Cluster:</label>
                                <input type="number" id="config-max_songs_per_cluster" class="w-full p-2 rounded-md bg-gray-700 border border-gray-600 focus:border-blue-500 focus:ring focus:ring-blue-500 focus:ring-opacity-50 text-gray-200">
                            </div>
                            <div class="mb-2">
                                <label for="config-pca_components_min" class="block text-sm font-medium text-gray-400 mb-1">PCA Components Min:</label>
                                <input type="number" id="config-pca_components_min" class="w-full p-2 rounded-md bg-gray-700 border border-gray-600 focus:border-blue-500 focus:ring focus:ring-blue-500 focus:ring-opacity-50 text-gray-200">
                            </div>
                            <div class="mb-2">
                                <label for="config-pca_components_max" class="block text-sm font-medium text-gray-400 mb-1">PCA Components Max:</label>
                                <input type="number" id="config-pca_components_max" class="w-full p-2 rounded-md bg-gray-700 border border-gray-600 focus:border-blue-500 focus:ring focus:ring-blue-500 focus:ring-opacity-50 text-gray-200">
                            </div>
                            <div class="mb-2">
                                <label for="config-clustering_runs" class="block text-sm font-medium text-gray-400 mb-1">Clustering Runs:</label>
                                <input type="number" id="config-clustering_runs" class="w-full p-2 rounded-md bg-gray-700 border border-gray-600 focus:border-blue-500 focus:ring focus:ring-blue-500 focus:ring-opacity-50 text-gray-200">
                            </div>
                        </div>

                        <div id="dbscan-params" class="grid grid-cols-1 md:grid-cols-2 gap-4 mt-4 hidden">
                            <h4 class="col-span-full text-lg font-medium text-blue-400 mb-2">DBSCAN Specific:</h4>
                            <div class="mb-2">
                                <label for="config-dbscan_eps_min" class="block text-sm font-medium text-gray-400 mb-1">DBSCAN Epsilon Min:</label>
                                <input type="number" step="0.01" id="config-dbscan_eps_min" class="w-full p-2 rounded-md bg-gray-700 border border-gray-600 focus:border-blue-500 focus:ring focus:ring-blue-500 focus:ring-opacity-50 text-gray-200">
                            </div>
                            <div class="mb-2">
                                <label for="config-dbscan_eps_max" class="block text-sm font-medium text-gray-400 mb-1">DBSCAN Epsilon Max:</label>
                                <input type="number" step="0.01" id="config-dbscan_eps_max" class="w-full p-2 rounded-md bg-gray-700 border border-gray-600 focus:border-blue-500 focus:ring focus:ring-blue-500 focus:ring-opacity-50 text-gray-200">
                            </div>
                            <div class="mb-2">
                                <label for="config-dbscan_min_samples_min" class="block text-sm font-medium text-gray-400 mb-1">DBSCAN Min Samples Min:</label>
                                <input type="number" id="config-dbscan_min_samples_min" class="w-full p-2 rounded-md bg-gray-700 border border-gray-600 focus:border-blue-500 focus:ring focus:ring-blue-500 focus:ring-opacity-50 text-gray-200">
                            </div>
                            <div class="mb-2">
                                <label for="config-dbscan_min_samples_max" class="block text-sm font-medium text-gray-400 mb-1">DBSCAN Min Samples Max:</label>
                                <input type="number" id="config-dbscan_min_samples_max" class="w-full p-2 rounded-md bg-gray-700 border border-gray-600 focus:border-blue-500 focus:ring focus:ring-blue-500 focus:ring-opacity-50 text-gray-200">
                            </div>
                        </div>

                        <div id="kmeans-params" class="grid grid-cols-1 md:grid-cols-2 gap-4 mt-4 hidden">
                            <h4 class="col-span-full text-lg font-medium text-blue-400 mb-2">K-Means Specific:</h4>
                            <div class="mb-2">
                                <label for="config-num_clusters_min" class="block text-sm font-medium text-gray-400 mb-1">Min Clusters:</label>
                                <input type="number" id="config-num_clusters_min" class="w-full p-2 rounded-md bg-gray-700 border border-gray-600 focus:border-blue-500 focus:ring focus:ring-blue-500 focus:ring-opacity-50 text-gray-200">
                            </div>
                            <div class="mb-2">
                                <label for="config-num_clusters_max" class="block text-sm font-medium text-gray-400 mb-1">Max Clusters:</label>
                                <input type="number" id="config-num_clusters_max" class="w-full p-2 rounded-md bg-gray-700 border border-gray-600 focus:border-blue-500 focus:ring focus:ring-blue-500 focus:ring-opacity-50 text-gray-200">
                            </div>
                        </div>

                        <div id="gmm-params" class="grid grid-cols-1 md:grid-cols-2 gap-4 mt-4 hidden">
                            <h4 class="col-span-full text-lg font-medium text-blue-400 mb-2">GMM Specific:</h4>
                            <div class="mb-2">
                                <label for="config-gmm_n_components_min" class="block text-sm font-medium text-gray-400 mb-1">GMM Components Min:</label>
                                <input type="number" id="config-gmm_n_components_min" class="w-full p-2 rounded-md bg-gray-700 border border-gray-600 focus:border-blue-500 focus:ring focus:ring-blue-500 focus:ring-opacity-50 text-gray-200">
                            </div>
                            <div class="mb-2">
                                <label for="config-gmm_n_components_max" class="block text-sm font-medium text-gray-400 mb-1">GMM Components Max:</label>
                                <input type="number" id="config-gmm_n_components_max" class="w-full p-2 rounded-md bg-gray-700 border border-gray-600 focus:border-blue-500 focus:ring focus:ring-blue-500 focus:ring-opacity-50 text-gray-200">
                            </div>
                        </div>
                    </fieldset>
                </form>
            </section>

            <section class="mb-8 p-6 bg-gray-900 rounded-lg shadow-inner border border-blue-800">
                <h2 class="text-2xl font-semibold text-blue-300 mb-4 flex items-center">
                    <i class="fas fa-play-circle mr-3 text-blue-500"></i>Run Tasks
                </h2>
                <div class="flex flex-col sm:flex-row gap-4 mb-4">
                    <button id="start-analysis-btn"
                            class="flex-1 bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-6 rounded-lg shadow-lg transition duration-300 ease-in-out transform hover:scale-105 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-opacity-75 disabled:opacity-50 disabled:cursor-not-allowed">
                        <i class="fas fa-chart-bar mr-2"></i> Start Analysis
                    </button>
                    <button id="start-clustering-btn"
                            class="flex-1 bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-6 rounded-lg shadow-lg transition duration-300 ease-in-out transform hover:scale-105 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-opacity-75 disabled:opacity-50 disabled:cursor-not-allowed">
                        <i class="fas fa-sitemap mr-2"></i> Start Clustering
                    </button>
                </div>
                <button id="cancel-task-btn"
                        class="w-full bg-red-600 hover:bg-red-700 text-white font-bold py-3 px-6 rounded-lg shadow-lg transition duration-300 ease-in-out transform hover:scale-105 focus:outline-none focus:ring-2 focus:ring-red-500 focus:ring-opacity-75 disabled:opacity-50 disabled:cursor-not-allowed mt-4">
                    <i class="fas fa-stop-circle mr-2"></i> Cancel Current Task
                </button>
            </section>

            <section class="p-6 bg-gray-900 rounded-lg shadow-inner border border-blue-800">
                <h2 class="text-2xl font-semibold text-blue-300 mb-4 flex items-center">
                    <i class="fas fa-info-circle mr-3 text-blue-500"></i>Task Status
                </h2>
                <div id="task-status-display" class="text-gray-300">
                    <p><span class="font-medium text-blue-400">Task ID:</span> <span id="status-task-id">N/A</span></p>
                    <p><span class="font-medium text-blue-400">Type:</span> <span id="status-task-type">N/A</span></p>
                    <p><span class="font-medium text-blue-400">Status:</span> <span id="status-status" class="font-bold text-yellow-400">IDLE</span></p>
                    <p><span class="font-medium text-blue-400">Progress:</span> <span id="status-progress">0</span>%</p>
                    <div class="w-full bg-gray-700 rounded-full h-2.5 mt-2">
                        <div id="progress-bar" class="bg-blue-500 h-2.5 rounded-full transition-all duration-500 ease-out" style="width: 0%;"></div>
                    </div>
                    <div class="mt-4">
                        <h3 class="font-medium text-blue-400 mb-2">Details / Log:</h3>
                        <pre id="status-details" class="log-area bg-gray-700 p-4 rounded-md text-sm overflow-auto max-h-60 text-gray-200 whitespace-pre-wrap"></pre>
                    </div>
                </div>
            </section>
        </div>
    </div>

    <script>
        const configForm = document.getElementById('config-form');
        const startAnalysisBtn = document.getElementById('start-analysis-btn');
        const startClusteringBtn = document.getElementById('start-clustering-btn');
        const cancelTaskBtn = document.getElementById('cancel-task-btn');
        const statusTaskId = document.getElementById('status-task-id');
        const statusTaskType = document.getElementById('status-task-type');
        const statusStatus = document.getElementById('status-status');
        const statusProgress = document.getElementById('status-progress');
        const progressBar = document.getElementById('progress-bar');
        const statusDetails = document.getElementById('status-details');
        const loadingSpinner = document.getElementById('loading-spinner');
        const mainContent = document.getElementById('main-content');

        // Clustering parameter containers
        const dbscanParamsDiv = document.getElementById('dbscan-params');
        const kmeansParamsDiv = document.getElementById('kmeans-params');
        const gmmParamsDiv = document.getElementById('gmm-params');
        const clusterAlgorithmSelect = document.getElementById('config-cluster_algorithm');


        let currentTaskId = null; // Stores the ID of the currently active task

        // Function to show/hide loading spinner
        function showLoading(show) {
            if (show) {
                loadingSpinner.classList.remove('hidden');
                loadingSpinner.classList.add('flex');
                mainContent.classList.add('hidden');
            } else {
                loadingSpinner.classList.add('hidden');
                loadingSpinner.classList.remove('flex');
                mainContent.classList.remove('hidden');
            }
        }

        // Fetches configuration from the backend
        async function fetchConfig() {
            showLoading(true);
            try {
                const response = await fetch('/api/config');
                const config = await response.json();
                renderConfig(config);
                toggleClusteringParams(); // Call after rendering config to set initial visibility
            } catch (error) {
                console.error('Error fetching config:', error);
                // Use a custom message box instead of alert
                showMessageBox('Error', 'Failed to load configuration. Please check the backend server.');
            } finally {
                showLoading(false);
            }
        }

        // Renders configuration fields into their respective sections
        function renderConfig(config) {
            // Populate General Parameters
            document.getElementById('config-jellyfin_url').value = config.jellyfin_url || '';
            document.getElementById('config-jellyfin_user_id').value = config.jellyfin_user_id || '';
            document.getElementById('config-jellyfin_token').value = config.jellyfin_token || '';

            // Populate Analysis Parameters
            document.getElementById('config-num_recent_albums').value = config.num_recent_albums || 0;
            document.getElementById('config-top_n_moods').value = config.top_n_moods || 0;

            // Populate Clustering Parameters (common ones)
            // Set K-Means as default if no value from config or if it's not 'dbscan' or 'gmm'
            clusterAlgorithmSelect.value = (config.cluster_algorithm === 'dbscan' || config.cluster_algorithm === 'gmm') ? config.cluster_algorithm : 'kmeans';

            document.getElementById('config-max_distance').value = config.max_distance || 0;
            document.getElementById('config-max_songs_per_cluster').value = config.max_songs_per_cluster || 0;
            document.getElementById('config-pca_components_min').value = config.pca_components_min || 0;
            document.getElementById('config-pca_components_max').value = config.pca_components_max || 0;
            document.getElementById('config-clustering_runs').value = config.clustering_runs || 0;

            // Populate algorithm-specific parameters (they will be hidden/shown by toggleClusteringParams)
            document.getElementById('config-dbscan_eps_min').value = config.dbscan_eps_min || 0;
            document.getElementById('config-dbscan_eps_max').value = config.dbscan_eps_max || 0;
            document.getElementById('config-dbscan_min_samples_min').value = config.dbscan_min_samples_min || 0;
            document.getElementById('config-dbscan_min_samples_max').value = config.dbscan_min_samples_max || 0;

            document.getElementById('config-num_clusters_min').value = config.num_clusters_min || 0;
            document.getElementById('config-num_clusters_max').value = config.num_clusters_max || 0;

            document.getElementById('config-gmm_n_components_min').value = config.gmm_n_components_min || 0;
            document.getElementById('config-gmm_n_components_max').value = config.gmm_n_components_max || 0;
        }

        // Toggles visibility of clustering parameters based on selected algorithm
        function toggleClusteringParams() {
            const selectedAlgorithm = clusterAlgorithmSelect.value;

            // Hide all algorithm-specific divs
            dbscanParamsDiv.classList.add('hidden');
            kmeansParamsDiv.classList.add('hidden');
            gmmParamsDiv.classList.add('hidden');

            // Show the div for the selected algorithm
            if (selectedAlgorithm === 'dbscan') {
                dbscanParamsDiv.classList.remove('hidden');
            } else if (selectedAlgorithm === 'kmeans') {
                kmeansParamsDiv.classList.remove('hidden');
            } else if (selectedAlgorithm === 'gmm') {
                gmmParamsDiv.classList.remove('hidden');
            }
        }

        // Fetches active tasks and updates UI accordingly
        async function checkActiveTasks() {
            try {
                const response = await fetch('/api/active_tasks');
                const activeTasks = await response.json();

                if (activeTasks && activeTasks.length > 0) {
                    // Assuming only one main task can be active based on requirements
                    const mainActiveTask = activeTasks.find(task => task.parent_task_id === null);

                    if (mainActiveTask) {
                        currentTaskId = mainActiveTask.task_id;
                        displayTaskStatus(mainActiveTask);
                        disableTaskButtons(true);
                        cancelTaskBtn.disabled = false;
                        return; // Exit if a main task is found
                    }
                }

                // If no main active task found, or no active tasks at all
                currentTaskId = null;
                displayTaskStatus({
                    task_id: 'N/A',
                    task_type: 'N/A',
                    status: 'IDLE',
                    progress: 0,
                    details: 'No active tasks.'
                });
                disableTaskButtons(false);
                cancelTaskBtn.disabled = true;

            } catch (error) {
                console.error('Error checking active tasks:', error);
                displayTaskStatus({
                    task_id: 'Error',
                    task_type: 'Error',
                    status: 'ERROR',
                    progress: 0,
                    details: `Failed to check active tasks: ${error.message}`
                });
                disableTaskButtons(false); // Re-enable buttons on error, allow retries
                cancelTaskBtn.disabled = true;
            }
        }

        // Disables/enables task initiation buttons
        function disableTaskButtons(isDisabled) {
            startAnalysisBtn.disabled = isDisabled;
            startClusteringBtn.disabled = isDisabled;
        }

        // Displays the status of a given task
        function displayTaskStatus(task) {
            statusTaskId.textContent = task.task_id;
            statusTaskType.textContent = task.task_type;
            statusStatus.textContent = task.status.toUpperCase();
            statusProgress.textContent = task.progress;
            progressBar.style.width = `${task.progress}%`;

            // Update status text color based on status
            statusStatus.classList.remove('text-yellow-400', 'text-green-400', 'text-red-400', 'text-blue-400');
            if (task.status.toUpperCase() === 'PENDING' || task.status.toUpperCase() === 'STARTED' || task.status.toUpperCase() === 'QUEUED') {
                statusStatus.classList.add('text-yellow-400');
            } else if (task.status.toUpperCase() === 'SUCCESS' || task.status.toUpperCase() === 'FINISHED') {
                statusStatus.classList.add('text-green-400');
            } else if (task.status.toUpperCase() === 'FAILURE' || task.status.toUpperCase() === 'FAILED' || task.status.toUpperCase() === 'REVOKED' || task.status.toUpperCase() === 'CANCELED') {
                statusStatus.classList.add('text-red-400');
            } else {
                statusStatus.classList.add('text-blue-400'); // For UNKNOWN/IDLE
            }

            try {
                let detailsText = task.details;
                if (typeof task.details === 'object' && task.details !== null) {
                    detailsText = JSON.stringify(task.details, null, 2);
                }
                statusDetails.textContent = detailsText;
            } catch (e) {
                statusDetails.textContent = `Error parsing details: ${e.message}\nRaw: ${task.details}`;
            }
            statusDetails.scrollTop = statusDetails.scrollHeight; // Scroll to bottom
        }

        // Starts a new task (analysis or clustering)
        async function startTask(taskType) {
            disableTaskButtons(true); // Immediately disable to prevent double clicks
            cancelTaskBtn.disabled = true; // Disable cancel until we get a task ID

            // Collect General Parameters
            const jellyfinUrl = document.getElementById('config-jellyfin_url').value;
            const jellyfinUserId = document.getElementById('config-jellyfin_user_id').value;
            const jellyfinToken = document.getElementById('config-jellyfin_token').value;

            const payload = {
                jellyfin_url: jellyfinUrl,
                jellyfin_user_id: jellyfinUserId,
                jellyfin_token: jellyfinToken
            };

            if (taskType === 'analysis') {
                // Collect Analysis Parameters
                payload.num_recent_albums = parseInt(document.getElementById('config-num_recent_albums').value);
                payload.top_n_moods = parseInt(document.getElementById('config-top_n_moods').value);
            } else if (taskType === 'clustering') {
                // Collect Clustering Parameters
                payload.clustering_method = clusterAlgorithmSelect.value;
                payload.max_distance = parseFloat(document.getElementById('config-max_distance').value);
                payload.max_songs_per_cluster = parseInt(document.getElementById('config-max_songs_per_cluster').value);
                payload.pca_components_min = parseInt(document.getElementById('config-pca_components_min').value);
                payload.pca_components_max = parseInt(document.getElementById('config-pca_components_max').value);
                payload.clustering_runs = parseInt(document.getElementById('config-clustering_runs').value);

                // Add algorithm-specific parameters to payload based on current selection
                if (payload.clustering_method === 'dbscan') {
                    payload.dbscan_eps_min = parseFloat(document.getElementById('config-dbscan_eps_min').value);
                    payload.dbscan_eps_max = parseFloat(document.getElementById('config-dbscan_eps_max').value);
                    payload.dbscan_min_samples_min = parseInt(document.getElementById('config-dbscan_min_samples_min').value);
                    payload.dbscan_min_samples_max = parseInt(document.getElementById('config-dbscan_min_samples_max').value);
                } else if (payload.clustering_method === 'kmeans') {
                    payload.num_clusters_min = parseInt(document.getElementById('config-num_clusters_min').value);
                    payload.num_clusters_max = parseInt(document.getElementById('config-num_clusters_max').value);
                } else if (payload.clustering_method === 'gmm') {
                    payload.gmm_n_components_min = parseInt(document.getElementById('config-gmm_n_components_min').value);
                    payload.gmm_n_components_max = parseInt(document.getElementById('config-gmm_n_components_max').value);
                }
            }

            try {
                const response = await fetch(`/api/${taskType}/start`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(payload)
                });
                const result = await response.json();
                if (response.ok) {
                    currentTaskId = result.task_id;
                    displayTaskStatus({
                        task_id: result.task_id,
                        task_type: result.task_type,
                        status: result.status,
                        progress: 0,
                        details: { message: 'Task enqueued successfully.' }
                    });
                    cancelTaskBtn.disabled = false; // Enable cancel once task is enqueued
                } else {
                    throw new Error(result.message || 'Failed to start task.');
                }
            } catch (error) {
                console.error(`Error starting ${taskType} task:`, error);
                showMessageBox('Error', `Failed to start ${taskType} task: ${error.message}`);
                disableTaskButtons(false); // Re-enable buttons on failure
                cancelTaskBtn.disabled = true;
                currentTaskId = null;
            }
        }

        // Cancels the currently active task
        async function cancelTask() {
            if (!currentTaskId) {
                showMessageBox('Info', 'No active task to cancel.');
                return;
            }

            cancelTaskBtn.disabled = true; // Disable button during cancellation attempt
            try {
                const response = await fetch(`/api/cancel/${currentTaskId}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });
                const result = await response.json();
                if (response.ok) {
                    showMessageBox('Success', result.message);
                    await checkActiveTasks(); // Force a status update immediately after cancellation
                } else {
                    throw new Error(result.message || 'Failed to cancel task.');
                }
            } catch (error) {
                console.error('Error cancelling task:', error);
                showMessageBox('Error', `Failed to cancel task: ${error.message}`);
            } finally {
                cancelTaskBtn.disabled = false; // Re-enable after attempt
            }
        }

        // Custom message box function (replaces alert)
        function showMessageBox(title, message) {
            const messageBox = document.createElement('div');
            messageBox.style.cssText = `
                position: fixed;
                top: 50%;
                left: 50%;
                transform: translate(-50%, -50%);
                background-color: #333;
                color: white;
                padding: 20px;
                border-radius: 8px;
                box-shadow: 0 4px 8px rgba(0,0,0,0.2);
                z-index: 1000;
                border: 1px solid #3b82f6; /* Blue-500 */
                max-width: 400px;
                text-align: center;
            `;
            messageBox.innerHTML = `
                <h3 style="font-weight: bold; margin-bottom: 10px; color: #93c5fd;">${title}</h3>
                <p>${message}</p>
                <button style="margin-top: 15px; padding: 8px 15px; background-color: #3b82f6; color: white; border: none; border-radius: 5px; cursor: pointer;" onclick="this.parentNode.remove()">OK</button>
            `;
            document.body.appendChild(messageBox);
        }

        // Event Listeners
        document.addEventListener('DOMContentLoaded', () => {
            fetchConfig();
            checkActiveTasks(); // Initial check for active tasks
            setInterval(checkActiveTasks, 3000); // Poll for active tasks every 3 seconds
            clusterAlgorithmSelect.addEventListener('change', toggleClusteringParams);
        });

        startAnalysisBtn.addEventListener('click', () => startTask('analysis'));
        startClusteringBtn.addEventListener('click', () => startTask('clustering'));
        cancelTaskBtn.addEventListener('click', cancelTask);
    </script>
</body>
</html>
