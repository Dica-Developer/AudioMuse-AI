<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="app-version" content="{{ app_version }}">
    <title>AudioMuse-AI - Music Map Universe</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='menu.css') }}">
    <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
    <style>
        .music-map-container {
            position: relative;
            width: 100%;
            height: 100vh;
            background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
            overflow: hidden;
        }

        .map-controls {
            position: absolute;
            top: 20px;
            left: 20px;
            right: 20px;
            z-index: 1000;
            display: flex;
            gap: 15px;
            align-items: center;
            background: rgba(0, 0, 0, 0.8);
            padding: 15px;
            border-radius: 10px;
            backdrop-filter: blur(10px);
        }

        .search-container {
            flex: 1;
            max-width: 400px;
            position: relative;
        }

        .search-input {
            width: 100%;
            padding: 12px 20px;
            border: 2px solid #4a90e2;
            border-radius: 25px;
            background: rgba(255, 255, 255, 0.9);
            font-size: 16px;
            outline: none;
            transition: all 0.3s ease;
        }

        .search-input:focus {
            border-color: #007bff;
            background: white;
            box-shadow: 0 0 20px rgba(0, 123, 255, 0.3);
        }

        .autocomplete-container {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: white;
            border: 1px solid #ddd;
            border-radius: 0 0 10px 10px;
            max-height: 200px;
            overflow-y: auto;
            z-index: 1001;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            display: none;
        }

        .autocomplete-item {
            padding: 12px 20px;
            cursor: pointer;
            border-bottom: 1px solid #eee;
            transition: background-color 0.2s ease;
        }

        .autocomplete-item:hover,
        .autocomplete-item.selected {
            background-color: #f0f8ff;
        }

        .autocomplete-item:last-child {
            border-bottom: none;
        }

        .song-title {
            font-weight: bold;
            color: #333;
            margin-bottom: 2px;
        }

        .song-artist {
            font-size: 0.9em;
            color: #666;
        }

        .map-info {
            color: white;
            font-size: 14px;
            margin-left: auto;
            display: flex;
            gap: 20px;
            align-items: center;
        }

        .info-item {
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .loading-indicator {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: white;
            text-align: center;
            z-index: 999;
            font-size: 18px;
        }

        .loading-spinner {
            border: 3px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top: 3px solid white;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 15px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .map-legend {
            position: absolute;
            bottom: 20px;
            left: 20px;
            background: rgba(0, 0, 0, 0.8);
            padding: 15px;
            border-radius: 10px;
            color: white;
            font-size: 12px;
            max-width: 300px;
            backdrop-filter: blur(10px);
        }

        .legend-title {
            font-weight: bold;
            margin-bottom: 10px;
            font-size: 14px;
        }

        .legend-item {
            display: flex;
            align-items: center;
            margin-bottom: 5px;
        }

        .legend-color {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-right: 8px;
        }

        .stats-panel {
            position: absolute;
            bottom: 20px;
            right: 20px;
            background: rgba(0, 0, 0, 0.8);
            padding: 15px;
            border-radius: 10px;
            color: white;
            font-size: 12px;
            backdrop-filter: blur(10px);
        }

        .error-message {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(255, 0, 0, 0.9);
            color: white;
            padding: 20px;
            border-radius: 10px;
            text-align: center;
            z-index: 1000;
        }

        /* Sidebar adjustments for full screen map */
        .main-content {
            padding: 0 !important;
            margin-left: 0 !important;
        }

        .main-content.sidebar-open {
            margin-left: 250px;
        }
    </style>
</head>
<body>
    <div class="page-container">
        <aside class="sidebar">
            <nav>
                <ul class="sidebar-nav">
                    <!-- Menu items are dynamically inserted by menu.js -->
                </ul>
            </nav>
        </aside>

        <div class="main-content" id="main-content">
            <button class="menu-toggle">&#9776;</button>
            
            <div class="music-map-container">
                <!-- Map Controls -->
                <div class="map-controls">
                    <div class="search-container">
                        <input type="text" id="searchInput" class="search-input" 
                               placeholder="Search for a song or artist to explore the music universe...">
                        <div id="autocompleteContainer" class="autocomplete-container"></div>
                    </div>
                    
                    <div class="map-info">
                        <div class="info-item">
                            <span>ðŸŽµ</span>
                            <span id="songCount">Loading...</span>
                        </div>
                        <div class="info-item">
                            <span>ðŸŽ¯</span>
                            <span id="zoomLevel">1.0x</span>
                        </div>
                    </div>
                </div>

                <!-- Loading Indicator -->
                <div id="loadingIndicator" class="loading-indicator">
                    <div class="loading-spinner"></div>
                    <div>Loading Music Universe...</div>
                    <div style="font-size: 14px; margin-top: 10px;">Mapping songs using AI embeddings</div>
                </div>

                <!-- Error Message -->
                <div id="errorMessage" class="error-message" style="display: none;"></div>

                <!-- Plot Container -->
                <div id="musicMapPlot" style="width: 100%; height: 100vh;"></div>

                <!-- Legend -->
                <div class="map-legend">
                    <div class="legend-title">All Stratified Genres</div>
                    <div style="max-height: 300px; overflow-y: auto;">
                        <!-- Legend items will be populated by JavaScript -->
                        <div id="legendItems"></div>
                    </div>
                </div>

                <!-- Stats Panel -->
                <div class="stats-panel">
                    <div><strong>Music Map Stats</strong></div>
                    <div id="mapBounds">Bounds: Loading...</div>
                    <div id="visibleSongs">Visible: -</div>
                </div>
            </div>
        </div>
    </div>

    <script src="{{ url_for('static', filename='menu.js') }}"></script>
    <script>
        let allSongs = [];
        let mapBounds = {};
        let plotLayout = {};

        // Initialize the music map
        async function initializeMusicMap() {
            try {
                console.log('Loading music map data...');
                
                const response = await fetch('/api/universe/music_map_data?limit=10000');  // Reduced to 10,000 for better performance
                const data = await response.json();
                
                if (!response.ok) {
                    throw new Error(data.error || 'Failed to load music map data');
                }

                allSongs = data.songs;
                mapBounds = data.bounds;
                
                console.log(`Loaded ${allSongs.length} songs for music map`);
                
                // Update info
                document.getElementById('songCount').textContent = `${allSongs.length} songs`;
                document.getElementById('mapBounds').textContent = 
                    `X: ${Math.round(mapBounds.min_x)} to ${Math.round(mapBounds.max_x)}, Y: ${Math.round(mapBounds.min_y)} to ${Math.round(mapBounds.max_y)}`;
                
                // Populate legend with actual genres found in the data
                populateLegend();
                
                // Render the map
                renderMusicMap();
                
                // Setup search
                setupSearchAutocomplete();
                
                // Hide loading indicator
                document.getElementById('loadingIndicator').style.display = 'none';
                
            } catch (error) {
                console.error('Error initializing music map:', error);
                showError('Failed to load music map: ' + error.message);
            }
        }

        // Populate legend with genres found in the actual data
        function populateLegend() {
            const genreCounts = {};
            
            // Count songs by genre
            allSongs.forEach(song => {
                genreCounts[song.genre] = (genreCounts[song.genre] || 0) + 1;
            });
            
            // Sort genres by count (descending)
            const sortedGenres = Object.entries(genreCounts)
                .sort((a, b) => b[1] - a[1])  // Sort by count
                .map(([genre, count]) => ({ genre, count, color: allSongs.find(s => s.genre === genre)?.genre_color || '#A9A9A9' }));
            
            // Populate legend items
            const legendContainer = document.getElementById('legendItems');
            legendContainer.innerHTML = sortedGenres.map(({genre, count, color}) => 
                `<div class="legend-item">
                    <div class="legend-color" style="background-color: ${color};"></div>
                    ${genre} (${count})
                </div>`
            ).join('');
        }

        // Render the music map using Plotly
        function renderMusicMap() {
            const trace = {
                x: allSongs.map(song => song.x),
                y: allSongs.map(song => song.y),
                mode: 'markers',
                type: 'scatter',
                marker: {
                    size: 8,
                    color: allSongs.map(song => song.genre_color),
                    line: {
                        width: 1,
                        color: 'rgba(255, 255, 255, 0.8)'
                    },
                    opacity: 0.8
                },
                text: allSongs.map(song => 
                    `<b>${song.title}</b><br>by ${song.author}<br>Genre: ${song.genre}<br>ID: ${song.item_id}`
                ),
                hovertemplate: '%{text}<extra></extra>',
                customdata: allSongs.map(song => song.item_id),
                name: 'Songs'
            };

            // Calculate bounds for auto-fitting
            const xValues = allSongs.map(song => song.x);
            const yValues = allSongs.map(song => song.y);
            const minX = Math.min(...xValues);
            const maxX = Math.max(...xValues);
            const minY = Math.min(...yValues);
            const maxY = Math.max(...yValues);
            
            // Add margin for better view
            const xMargin = (maxX - minX) * 0.1;
            const yMargin = (maxY - minY) * 0.1;

            plotLayout = {
                title: {
                    text: 'Music Universe Map - Explore by Similarity',
                    font: { color: 'white', size: 20 },
                    x: 0.5
                },
                xaxis: {
                    title: 'Musical Space (X)',
                    showgrid: false,
                    zeroline: false,
                    showticklabels: false,
                    color: 'white',
                    range: [minX - xMargin, maxX + xMargin]  // Auto-fit to show all songs
                },
                yaxis: {
                    title: 'Musical Space (Y)', 
                    showgrid: false,
                    zeroline: false,
                    showticklabels: false,
                    color: 'white',
                    range: [minY - yMargin, maxY + yMargin]  // Auto-fit to show all songs
                },
                plot_bgcolor: 'rgba(0,0,0,0)',
                paper_bgcolor: 'rgba(0,0,0,0)',
                font: { color: 'white' },
                showlegend: false,
                hovermode: 'closest',
                dragmode: 'pan'
            };

            const config = {
                responsive: true,
                displayModeBar: true,
                modeBarButtonsToRemove: ['toImage', 'sendDataToCloud'],
                displaylogo: false,
                scrollZoom: true
            };

            Plotly.newPlot('musicMapPlot', [trace], plotLayout, config);

            // Add event listeners
            const plotDiv = document.getElementById('musicMapPlot');
            
            // Track zoom/pan changes to update zoom level display
            plotDiv.on('plotly_relayout', function(eventdata) {
                updateZoomLevel(eventdata);
            });

            // Handle song clicks
            plotDiv.on('plotly_click', function(data) {
                if (data.points && data.points.length > 0) {
                    const clickedSongId = data.points[0].customdata;
                    console.log('Clicked song:', clickedSongId);
                    
                    // Find the song and show details
                    const song = allSongs.find(s => s.item_id === clickedSongId);
                    if (song) {
                        showSongDetails(song);
                    }
                }
            });
        }

        // Show song details (could be enhanced with a modal or side panel)
        function showSongDetails(song) {
            console.log('Song details:', song);
            // Could implement a detail panel here
        }

        // Update zoom level display
        function updateZoomLevel(eventdata) {
            if (eventdata && (eventdata['xaxis.range[0]'] !== undefined || eventdata['xaxis.range[1]'] !== undefined)) {
                const plotDiv = document.getElementById('musicMapPlot');
                const xRange = plotDiv.layout.xaxis.range;
                const yRange = plotDiv.layout.yaxis.range;
                
                if (xRange && yRange) {
                    const xSpan = Math.abs(xRange[1] - xRange[0]);
                    const ySpan = Math.abs(yRange[1] - yRange[0]);
                    const totalRange = Math.abs(mapBounds.max_x - mapBounds.min_x) + Math.abs(mapBounds.max_y - mapBounds.min_y);
                    const currentRange = xSpan + ySpan;
                    const zoomLevel = Math.max(0.1, totalRange / currentRange).toFixed(1);
                    
                    document.getElementById('zoomLevel').textContent = `${zoomLevel}x`;
                }
            }
        }

        // Setup search autocomplete
        function setupSearchAutocomplete() {
            const searchInput = document.getElementById('searchInput');
            const autocompleteContainer = document.getElementById('autocompleteContainer');
            
            let selectedIndex = -1;
            
            searchInput.addEventListener('input', function() {
                const query = this.value.toLowerCase().trim();
                
                if (query.length < 2) {
                    autocompleteContainer.style.display = 'none';
                    return;
                }
                
                // Filter songs
                const matches = allSongs.filter(song => 
                    song.title.toLowerCase().includes(query) || 
                    song.author.toLowerCase().includes(query)
                ).slice(0, 10);
                
                if (matches.length === 0) {
                    autocompleteContainer.style.display = 'none';
                    return;
                }
                
                // Build autocomplete items
                autocompleteContainer.innerHTML = matches.map((song, index) => `
                    <div class="autocomplete-item" data-index="${index}" data-item-id="${song.item_id}">
                        <div class="song-title">${song.title}</div>
                        <div class="song-artist">${song.author} - ${song.genre}</div>
                    </div>
                `).join('');
                
                // Add click handlers
                autocompleteContainer.querySelectorAll('.autocomplete-item').forEach(item => {
                    item.addEventListener('click', function() {
                        const itemId = this.getAttribute('data-item-id');
                        selectSong(itemId);
                    });
                });
                
                autocompleteContainer.style.display = 'block';
                selectedIndex = -1;
            });
            
            searchInput.addEventListener('keydown', function(e) {
                const items = autocompleteContainer.querySelectorAll('.autocomplete-item');
                
                if (e.key === 'ArrowDown') {
                    e.preventDefault();
                    selectedIndex = Math.min(selectedIndex + 1, items.length - 1);
                    updateSelection(items);
                } else if (e.key === 'ArrowUp') {
                    e.preventDefault();
                    selectedIndex = Math.max(selectedIndex - 1, -1);
                    updateSelection(items);
                } else if (e.key === 'Enter') {
                    e.preventDefault();
                    if (selectedIndex >= 0 && items[selectedIndex]) {
                        const itemId = items[selectedIndex].getAttribute('data-item-id');
                        selectSong(itemId);
                    }
                } else if (e.key === 'Escape') {
                    autocompleteContainer.style.display = 'none';
                    selectedIndex = -1;
                }
            });
            
            function updateSelection(items) {
                items.forEach((item, index) => {
                    item.classList.toggle('selected', index === selectedIndex);
                });
            }
            
            // Hide autocomplete when clicking outside
            document.addEventListener('click', function(e) {
                if (!searchInput.contains(e.target) && !autocompleteContainer.contains(e.target)) {
                    autocompleteContainer.style.display = 'none';
                }
            });
        }

        // Select and focus on a specific song
        function selectSong(itemId) {
            const song = allSongs.find(s => s.item_id === itemId);
            if (!song) return;
            
            console.log('Focusing on song:', song);
            
            // Hide autocomplete
            document.getElementById('autocompleteContainer').style.display = 'none';
            document.getElementById('searchInput').value = `${song.title} - ${song.author}`;
            
            // Focus on the song on the map
            const margin = 200; // Zoom margin
            
            Plotly.relayout('musicMapPlot', {
                'xaxis.range': [song.x - margin, song.x + margin],
                'yaxis.range': [song.y - margin, song.y + margin]
            });
            
            // Load connections for this song
            setTimeout(() => loadSongConnections(itemId), 500);
        }

        // Show error message
        function showError(message) {
            document.getElementById('loadingIndicator').style.display = 'none';
            const errorDiv = document.getElementById('errorMessage');
            errorDiv.textContent = message;
            errorDiv.style.display = 'block';
            
            setTimeout(() => {
                errorDiv.style.display = 'none';
            }, 5000);
        }

        // Initialize when page loads
        window.addEventListener('load', initializeMusicMap);
    </script>
</body>
</html>