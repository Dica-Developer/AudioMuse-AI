<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Find Similar Tracks</title>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif; margin: 2em; background-color: #f4f4f9; color: #333; }
        h1 { color: #444; }
        form { background: #fff; padding: 2em; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        label { font-weight: bold; display: block; margin-bottom: 0.5em; }
        input[type="text"], input[type="number"] { width: calc(100% - 22px); padding: 10px; margin-bottom: 1em; border: 1px solid #ccc; border-radius: 4px; }
        button { background-color: #007bff; color: white; padding: 10px 15px; border: none; border-radius: 4px; cursor: pointer; font-size: 1em; }
        button:hover { background-color: #0056b3; }
        #results-container { margin-top: 2em; background: #fff; padding: 2em; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); display: none; }
        table { border-collapse: collapse; width: 100%; }
        th, td { border-bottom: 1px solid #ddd; padding: 12px; text-align: left; }
        th { background-color: #f8f8f8; }
        tr:nth-child(even) { background-color: #f2f2f2; }
        .success { color: #28a745; font-weight: bold; }
        .error { color: #d9534f; font-weight: bold; }
        #status { margin-bottom: 1em; }
    </style>
</head>
<body>
    <h1>Find Similar Tracks</h1>
    <form id="similarity-form">
        <label for="item_id">Track Item ID:</label>
        <input type="text" id="item_id" name="item_id" placeholder="e.g., 3a6d..." required>
        
        <label for="n">Number of results:</label>
        <input type="number" id="n" name="n" value="10" min="1" max="100">
        <br><br>
        <button type="submit">Find Similar Tracks</button>
    </form>

    <div id="results-container">
        <h2>Results</h2>
        <div id="status"></div>
        <div id="results-table"></div>
    </div>

    <div id="playlist-creator" style="display: none; margin-top: 2em; background: #fff; padding: 2em; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
        <h2>Create a Playlist from Results</h2>
        <form id="playlist-form">
            <label for="playlist_name">Playlist Name:</label>
            <input type="text" id="playlist_name" name="playlist_name" required placeholder="e.g., My Awesome Mix">
            <br><br>
            <button type="submit">Create Playlist in Jellyfin</button>
        </form>
        <div id="playlist-status" style="margin-top: 1em;"></div>
    </div>

    <script>
        let currentTrackIds = []; // To store the IDs from the latest search

        document.getElementById('similarity-form').addEventListener('submit', async function (event) {
            event.preventDefault();

            const itemId = document.getElementById('item_id').value;
            const n = document.getElementById('n').value;
            const statusDiv = document.getElementById('status');
            const resultsTableDiv = document.getElementById('results-table');
            const resultsContainer = document.getElementById('results-container');
            const playlistCreator = document.getElementById('playlist-creator');

            resultsContainer.style.display = 'block';
            statusDiv.textContent = 'Searching...';
            statusDiv.className = '';
            resultsTableDiv.innerHTML = '';

            try {
                const response = await fetch(`/api/similar_tracks/${itemId}?n=${n}`);
                const data = await response.json();

                if (!response.ok) throw new Error(data.error || `HTTP error! status: ${response.status}`);
                if (data.length === 0) {
                    playlistCreator.style.display = 'none';
                    statusDiv.textContent = 'No similar tracks found.';
                    return;
                }

                // Store track IDs for playlist creation
                currentTrackIds = data.map(track => track.item_id);

                statusDiv.textContent = '';
                const tableHTML = `<table><thead><tr><th>Title</th><th>Author</th><th>Distance</th><th>Item ID</th></tr></thead><tbody>${data.map(track => `<tr><td>${track.title}</td><td>${track.author}</td><td>${track.distance.toFixed(4)}</td><td>${track.item_id}</td></tr>`).join('')}</tbody></table>`;
                resultsTableDiv.innerHTML = tableHTML;
                playlistCreator.style.display = 'block';
                document.getElementById('playlist-status').textContent = '';
            } catch (error) {
                statusDiv.textContent = `Error: ${error.message}`;
                statusDiv.className = 'error';
                console.error('Fetch error:', error);
            }
        });

        document.getElementById('playlist-form').addEventListener('submit', async function (event) {
            event.preventDefault();

            const playlistName = document.getElementById('playlist_name').value;
            const playlistStatusDiv = document.getElementById('playlist-status');

            if (!playlistName) {
                playlistStatusDiv.textContent = 'Please enter a playlist name.';
                playlistStatusDiv.className = 'error';
                return;
            }

            if (currentTrackIds.length === 0) {
                playlistStatusDiv.textContent = 'No tracks to add. Please perform a search first.';
                playlistStatusDiv.className = 'error';
                return;
            }

            playlistStatusDiv.textContent = 'Creating playlist...';
            playlistStatusDiv.className = '';

            try {
                const response = await fetch('/api/create_playlist', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        playlist_name: playlistName,
                        track_ids: currentTrackIds
                    }),
                });

                const result = await response.json();
                if (!response.ok) throw new Error(result.error || `HTTP error! status: ${response.status}`);

                playlistStatusDiv.textContent = result.message;
                playlistStatusDiv.className = 'success';
                document.getElementById('playlist-form').reset();
            } catch (error) {
                playlistStatusDiv.textContent = `Error: ${error.message}`;
                playlistStatusDiv.className = 'error';
                console.error('Playlist creation error:', error);
            }
        });
    </script>
</body>
</html>